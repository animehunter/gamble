<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><title>4&nbsp;Notes, Plans, Limitations, and Known Bugs</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="scribble-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-fonts.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Prob:<span class="mywbr"> &nbsp;</span> Probabilistic Programming</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="intro.html" class="tocviewlink" data-pltdoc="x">Introduction</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="features.html" class="tocviewlink" data-pltdoc="x">Probabilistic Features</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="solvers.html" class="tocviewlink" data-pltdoc="x">Samplers and Solvers</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="notes.html" class="tocviewselflink" data-pltdoc="x">Notes, Plans, Limitations, and Known Bugs</a></td></tr><tr><td align="right"></td><td><a href="prob-bibliography.html" class="tocviewlink" data-pltdoc="x">Bibliography</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>4&nbsp;</td><td><a href="notes.html" class="tocviewselflink" data-pltdoc="x">Notes, Plans, Limitations, and Known Bugs</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">4.1&nbsp;</td><td><a href="notes.html#%28part._.Notes_on_mh-sampler%29" class="tocviewlink" data-pltdoc="x">Notes on <span class="RktSym"><span class="RktStxLink">mh-<wbr></wbr>sampler</span></span></a></td></tr><tr><td align="right">4.2&nbsp;</td><td><a href="notes.html#%28part._.Notes_on_enumerate%29" class="tocviewlink" data-pltdoc="x">Notes on <span class="RktSym"><span class="RktStxLink">enumerate</span></span></a></td></tr><tr><td align="right">4.3&nbsp;</td><td><a href="notes.html#%28part._nesting%29" class="tocviewlink" data-pltdoc="x">Nesting Samplers/<span class="mywbr"> &nbsp;</span>Solvers</a></td></tr><tr><td align="right">4.4&nbsp;</td><td><a href="notes.html#%28part._.Plans%29" class="tocviewlink" data-pltdoc="x">Plans</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">4.1<tt>&nbsp;</tt></span><a href="#%28part._.Notes_on_mh-sampler%29" class="tocsubseclink" data-pltdoc="x">Notes on <span class="RktSym"><span class="RktStxLink">mh-<wbr></wbr>sampler</span></span></a></td></tr><tr><td><span class="tocsublinknumber">4.1.1<tt>&nbsp;</tt></span><a href="#%28part._.Address_representation%29" class="tocsubseclink" data-pltdoc="x">Address representation</a></td></tr><tr><td><span class="tocsublinknumber">4.1.2<tt>&nbsp;</tt></span><a href="#%28part._.Instrumentation%29" class="tocsubseclink" data-pltdoc="x">Instrumentation</a></td></tr><tr><td><span class="tocsublinknumber">4.2<tt>&nbsp;</tt></span><a href="#%28part._.Notes_on_enumerate%29" class="tocsubseclink" data-pltdoc="x">Notes on <span class="RktSym"><span class="RktStxLink">enumerate</span></span></a></td></tr><tr><td><span class="tocsublinknumber">4.3<tt>&nbsp;</tt></span><a href="#%28part._nesting%29" class="tocsubseclink" data-pltdoc="x">Nesting Samplers/<span class="mywbr"> &nbsp;</span>Solvers</a></td></tr><tr><td><span class="tocsublinknumber">4.4<tt>&nbsp;</tt></span><a href="#%28part._.Plans%29" class="tocsubseclink" data-pltdoc="x">Plans</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft">&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="solvers.html" title="backward to &quot;3 Samplers and Solvers&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Prob: Probabilistic Programming&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="prob-bibliography.html" title="forward to &quot;Bibliography&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3>4<tt>&nbsp;</tt><a name="(part._notes)"></a>Notes, Plans, Limitations, and Known Bugs</h3><p>Users must various language features, including side effects
(particularly mutation) and certain higher-order functions in certain
situations.</p><p>My code is not written numerically carefully at all. It will need
review.</p><p>There&rsquo;s a very preliminary typed lang that builds on Typed Racket. It
will probably be necessary to add some of <a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">prob</span></a>&rsquo;s
primitives to the type environment (ie, assert, not typecheck). Also,
there&rsquo;s a binding issue that prevents definitions from being used
outside the module.</p><h4>4.1<tt>&nbsp;</tt><a name="(part._.Notes_on_mh-sampler)"></a>Notes on <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span></h4><p>The address-tracking part is in pretty good shape. The ML part is
lacking.</p><p>Currently the &ldquo;proposal function&rdquo; just picks an ERP choice at random
(uniformly from the list of ERP choices from the database) and deletes
it. That corresponds to the naive &ldquo;just re-evaluate it&rdquo; strategy
mentioned in [<a href="prob-bibliography.html#%28cite._.Church%29" data-pltdoc="x">Church</a>]. It&rsquo;s pretty bad.</p><p>One possible path for improvement is adding automatic differentiation
like [<a href="prob-bibliography.html#%28cite._.Bher%29" data-pltdoc="x">Bher</a>], but it looks messy. Specifically, it looks like it
would complicate interoperation with libraries.</p><p>The context of an ERP use must not contain any higher-order functions
imported from uninstrumented modules, such as Racket&rsquo;s <span class="RktSym"><a href="http://docs.racket-lang.org/reference/pairs.html#%28def._%28%28lib._racket%2Fprivate%2Fmap..rkt%29._map%29%29" class="RktValLink" data-pltdoc="x">map</a></span>
function. Higher-order functions that take a single function argument
and apply it at most once (such as <span class="RktSym"><a href="http://docs.racket-lang.org/reference/file-ports.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._call-with-input-file%29%29" class="RktValLink" data-pltdoc="x">call-with-input-file</a></span>)
are safe, however.</p><h5>4.1.1<tt>&nbsp;</tt><a name="(part._.Address_representation)"></a>Address representation</h5><p>Addresses are collected in continuation marks rather than as passed as
an additional argument. That avoids changing function signature,
simplifying interop.</p><p>Version 1 (bad): <span style="font-style: italic">An Address is a list of CallSite&#8212;<wbr></wbr>the list
of call sites in the context (continuation), most recent first.</span></p><p>Note: call site, not function. Consider <span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span class="RktPn">)</span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym">h</span><span class="RktPn">)</span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym">h</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span>&#8212;<wbr></wbr>need to distinguish separate calls to <span class="RktSym">h</span>. (But what
if function changes? Well, what if an argument changes? We&rsquo;re ignoring
the latter, so might as well ignore the former too.)</p><p>Store address in context using <span class="RktSym"><a href="http://docs.racket-lang.org/reference/wcm.html#%28form._%28%28quote._~23~25kernel%29._with-continuation-mark%29%29" class="RktStxLink" data-pltdoc="x">with-continuation-mark</a></span> (WCM)
and retrieve using <span class="RktSym"><a href="http://docs.racket-lang.org/reference/contmarks.html#%28def._%28%28quote._~23~25kernel%29._current-continuation-marks%29%29" class="RktValLink" data-pltdoc="x">current-continuation-marks</a></span> (CCM).</p><p>Problem: tail calls. If a function <span class="RktSym">f</span> tail-calls itself, then
second WCM overwrites first; calls within the two activations of
<span class="RktSym">f</span> will have colliding addresses. Also if <span class="RktSym">f</span>
tail-calls <span class="RktSym">g</span> then <span class="RktSym">g</span> tail-calls <span class="RktSym">f</span>, we get a
collision from the two <span class="RktSym">f</span> activations. And so on.  (See
<span class="RktSym">sum-n-flips*</span> in <span class="stt">examples.rkt</span>.)</p><p>Version 2 (current): <span style="font-style: italic">An Address is a list of CallSequence&#8212;<wbr></wbr>a
list of tail-call sequences, most recent first. A CallSequence is an
improper list of CallSite.</span></p><p>A CallSequence is started by a non-tail call; that call site is the
end of the improper list. Each subsequent tail call gets added to the
list.</p><p>Issue: This may change the space complexity of the program. But it
needs to make finer distinction than original program, so it&rsquo;s
somewhat justified.</p><p>It might be possible to devise ad-hoc representation optimizations,
like run-length encoding for self-tail-calling functions. CFA could
probably help.</p><h5>4.1.2<tt>&nbsp;</tt><a name="(part._.Instrumentation)"></a>Instrumentation</h5><p>Call-sites are instrumented after expansion, so macros like
<span class="RktSym"><a href="http://docs.racket-lang.org/reference/for.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for%2Flist%29%29" class="RktStxLink" data-pltdoc="x">for/list</a></span> get instrumented but higher-order functions like
<span class="RktSym"><a href="http://docs.racket-lang.org/reference/pairs.html#%28def._%28%28lib._racket%2Fprivate%2Fmap..rkt%29._map%29%29" class="RktValLink" data-pltdoc="x">map</a></span> don&rsquo;t, since they&rsquo;re defined in uninstrumented modules.</p><h4>4.2<tt>&nbsp;</tt><a name="(part._.Notes_on_enumerate)"></a>Notes on <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span></h4><p>The context of an ERP use must not include any uses of
<span class="RktSym"><a href="http://docs.racket-lang.org/reference/parameters.html#%28form._%28%28lib._racket%2Fprivate%2Fmore-scheme..rkt%29._parameterize%29%29" class="RktStxLink" data-pltdoc="x">parameterize</a></span>, which doesn&rsquo;t cooperate correctly with
delimited continuations.</p><p><div class="SIntrapara">[<a href="prob-bibliography.html#%28cite._.E.P.P%29" data-pltdoc="x">EPP</a>] talks about
</div><div class="SIntrapara"><ul><li><p><span style="font-weight: bold">reification and reflection</span>&#8212;<wbr></wbr>Working, using <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span>
to reify and <span class="RktSym"><a href="features.html#%28def._%28%28lib._prob%2Fmain..rkt%29._discrete-from-enumeration%29%29" class="RktValLink" data-pltdoc="x">discrete-from-enumeration</a></span> to reflect. See
example <span class="stt">xor-flips</span> (exponential time) and <span class="stt">xor-flips*</span>
(linear).</p><p>Question: is the <span class="stt">memo</span> function at the end of[<a href="prob-bibliography.html#%28cite._.E.P.P%29" data-pltdoc="x">EPP</a>] section 3
just naive memoization?</p></li><li><p><span style="font-weight: bold">importance sampling with look-ahead</span>&#8212;<wbr></wbr>Not implemented
yet. Looks promising.</p></li><li><p><span style="font-weight: bold">lazy evaluation</span>&#8212;<wbr></wbr>I think the implementation of
<span class="RktSym"><a href="features.html#%28def._%28%28lib._prob%2Fmain..rkt%29._mem%29%29" class="RktValLink" data-pltdoc="x">mem</a></span> I have for is a generalization of their <span class="stt">letlazy</span>. See
<span class="stt">flips-all-true</span> and <span class="stt">flips-all-true*</span> for supporting evidence.</p></li></ul></div></p><p>I made up some stuff to handle countable distributions and infinite
trees by pruning low-relevance paths.</p><p>Note: pruning only happens on terminated paths. There&rsquo;s no way to
reject a path based on the choices it&rsquo;s made so far. How would such a
condition be formulated, and how would it be implemented?</p><h4>4.3<tt>&nbsp;</tt><a name="(part._nesting)"></a>Nesting Samplers/Solvers</h4><p>What nestings are okay? I&rsquo;ve put more thought and effort into the
<span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span> nestings; there&rsquo;s some basic stuff missing for
<span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span> nesting.</p><ul><li><p><span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span> within <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span></p><p>Should work, including <span class="RktSym"><a href="features.html#%28def._%28%28lib._prob%2Fmain..rkt%29._mem%29%29" class="RktValLink" data-pltdoc="x">mem</a></span> (mostly). An
outer-mem-function used in the inner <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span> should
work (ie, fork the outer context), and an inner-mem-function
that escapes to the outer <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span> should raise an
out-of-context error.</p><p>TODO: Handle the HO case where an inner-mem-function is passed
to an outer-mem-function which then calls it. That should be
considered the inner-mem-function escaping its context.</p></li><li><p><span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span> within <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span></p><p>Should work, except for some <span class="RktSym"><a href="features.html#%28def._%28%28lib._prob%2Fmain..rkt%29._mem%29%29" class="RktValLink" data-pltdoc="x">mem</a></span> cases.</p><p>TODO: An outer-mem-function called in inner <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span>
should use outer (MH) ERP impl.</p><p>An inner-mem-function that escapes should raise an
out-of-context error.</p><p>TODO: same HO case as above.</p><p>TODO: if <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span> gets caching, disable within
<span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span>.</p></li><li><p><span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span> within <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._enumerate%29%29" class="RktStxLink" data-pltdoc="x">enumerate</a></span></p><p>Should work, except for <span class="RktSym"><a href="features.html#%28def._%28%28lib._prob%2Fmain..rkt%29._mem%29%29" class="RktValLink" data-pltdoc="x">mem</a></span>.</p><p>TODO: implement out-of-context check for mem-functions created
within <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span>.</p><p>TODO: prohibit outer-mem-function from being called from
<span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span>. Also, same cases as above.</p></li><li><p><span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span> within <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span></p><p>Inner MH database won&rsquo;t affect outer MH database. Thus
outer-mem-function used in inner <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span> won&rsquo;t
retain value.</p></li></ul><h4>4.4<tt>&nbsp;</tt><a name="(part._.Plans)"></a>Plans</h4><p>Improve the syntax of <span class="RktSym"><a href="solvers.html#%28form._%28%28lib._prob%2Fmain..rkt%29._mh-sampler%29%29" class="RktStxLink" data-pltdoc="x">mh-sampler</a></span> etc to support conditions
intermixed with definitions, subject to proper scoping. That would
make it easier (potentially) to reject samples at an earlier stage.</p><p>Module/unit/structure/functor-like thing for models. Should be able to
define a model once and then plug it into any kind of sampler/solver
framework, compose it with other models, add conditions, apply
transformations (eg, replace definitions a la traits or mixin
modules?), etc.</p><p>Address-based caching.</p><div class="navsetbottom"><span class="navleft">&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="solvers.html" title="backward to &quot;3 Samplers and Solvers&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Prob: Probabilistic Programming&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="prob-bibliography.html" title="forward to &quot;Bibliography&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>